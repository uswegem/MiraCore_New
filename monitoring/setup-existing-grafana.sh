#!/bin/bash

echo "ğŸ”§ Setting up ESS Monitoring for existing Grafana instance..."
echo "ğŸ“ Grafana URL: http://5.75.185.137:3000/"

# Install prom-client for Node.js metrics
echo "ğŸ“¦ Installing prom-client dependency..."
npm install prom-client

echo "ğŸ”§ Setting up metrics endpoint in your ESS application..."
echo ""
echo "âœ… Next steps to complete setup:"
echo ""
echo "1. ğŸ“Š Add metrics to your ESS server.js:"
echo "   Add these lines to your server.js file:"
echo ""
echo "   const { httpMetricsMiddleware, metricsHandler, trackLoanMessage } = require('./src/middleware/metricsMiddleware');"
echo "   app.use(httpMetricsMiddleware);"
echo "   app.get('/metrics', metricsHandler);"
echo ""
echo "2. ğŸ”„ Restart your ESS application:"
echo "   pm2 restart ess-app"
echo ""
echo "3. âœ… Verify metrics endpoint is working:"
echo "   curl http://135.181.33.13:3002/metrics"
echo ""
echo "4. ğŸ“Š Import dashboard to existing Grafana:"
echo "   - Open http://5.75.185.137:3000/"
echo "   - Go to '+' â†’ 'Import'"
echo "   - Upload: monitoring/grafana-dashboard.json"
echo "   - Or copy dashboard ID: Copy the JSON content"
echo ""
echo "5. ğŸ¯ Add Prometheus datasource in Grafana:"
echo "   - Go to Configuration â†’ Data Sources"
echo "   - Add Prometheus datasource"
echo "   - URL: http://prometheus:9090 (or your Prometheus URL)"
echo ""
echo "6. ğŸ“ˆ Configure Prometheus to scrape ESS metrics:"
echo "   - Add the prometheus.yml configuration to your Prometheus instance"
echo "   - Restart Prometheus to pick up new targets"
echo ""
echo "ğŸ” Test endpoints:"
echo "   ESS Metrics: http://135.181.33.13:3002/metrics"
echo "   Grafana:     http://5.75.185.137:3000/"
echo ""
echo "ğŸ“‹ Files created:"
echo "   - monitoring/grafana-dashboard.json (Dashboard definition)"
echo "   - src/middleware/metricsMiddleware.js (Metrics collection)"
echo "   - monitoring/prometheus.yml (Prometheus config)"