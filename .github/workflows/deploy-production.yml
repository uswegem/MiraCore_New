name: Deploy to Production

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm install
      
    - name: Run tests (if any)
      run: npm test --if-present
      
    - name: Check SSH secrets
      id: check_secrets
      run: |
        if [ -z "${{ secrets.PRODUCTION_SSH_KEY }}" ]; then
          echo "ssh_available=false" >> $GITHUB_OUTPUT
          echo "‚ö†Ô∏è SSH secrets not configured - using manual deployment mode"
        else
          echo "ssh_available=true" >> $GITHUB_OUTPUT
          echo "‚úÖ SSH secrets available - using automated deployment"
        fi
        
    - name: Setup SSH key (if available)
      if: steps.check_secrets.outputs.ssh_available == 'true'
      uses: webfactory/ssh-agent@v0.8.0
      with:
        ssh-private-key: ${{ secrets.PRODUCTION_SSH_KEY }}
        
    - name: Add server to known hosts (if SSH available)
      if: steps.check_secrets.outputs.ssh_available == 'true'
      run: |
        ssh-keyscan -H 135.181.33.13 >> ~/.ssh/known_hosts
        
    - name: Deploy to production (SSH mode)
      if: steps.check_secrets.outputs.ssh_available == 'true'
      run: |
        # Create deployment package
        tar -czf deployment.tar.gz \
          --exclude='.git' \
          --exclude='node_modules' \
          --exclude='.github' \
          --exclude='*.log' \
          --exclude='logs/*' \
          --exclude='.env.local' \
          .
        
        # Copy to server
        scp deployment.tar.gz ${{ secrets.PRODUCTION_USER }}@135.181.33.13:/tmp/
        
        # Deploy on server
        ssh ${{ secrets.PRODUCTION_USER }}@135.181.33.13 '
          set -e
          
          # Backup current deployment
          sudo mkdir -p /home/uswege/backups
          sudo tar -czf /home/uswege/backups/ess-backup-$(date +%Y%m%d_%H%M%S).tar.gz -C /home/uswege ess 2>/dev/null || echo "No existing deployment to backup"
          
          # Extract new deployment
          cd /home/uswege
          tar -xzf /tmp/deployment.tar.gz -C ess/
          
          # Install/update dependencies
          cd /home/uswege/ess
          npm install --production
          
          # Restart services
          pm2 restart all
          
          # Verify deployment
          sleep 5
          curl -f http://localhost:3002/health || (echo "Health check failed" && exit 1)
          
          # Cleanup
          rm /tmp/deployment.tar.gz
          
          echo "‚úÖ Deployment completed successfully"
        '
        
    - name: Manual deployment instructions (no SSH)
      if: steps.check_secrets.outputs.ssh_available == 'false'
      run: |
        echo "üìã Manual Deployment Required"
        echo "================================"
        echo ""
        echo "SSH secrets are not configured. Please deploy manually:"
        echo ""
        echo "1. Download the repository:"
        echo "   git clone https://github.com/uswegem/MiraCore_New.git"
        echo "   cd MiraCore_New"
        echo ""
        echo "2. Copy to server:"
        echo "   scp -r . uswege@135.181.33.13:/home/uswege/ess/"
        echo ""
        echo "3. Connect to server and restart:"
        echo "   ssh uswege@135.181.33.13"
        echo "   cd /home/uswege/ess"
        echo "   npm install --production"
        echo "   pm2 restart all"
        echo ""
        echo "4. Verify deployment:"
        echo "   curl http://135.181.33.13:3002/health"
        echo ""
        echo "To enable automatic deployment, add these GitHub secrets:"
        echo "  - PRODUCTION_SSH_KEY: Your SSH private key"
        echo "  - PRODUCTION_USER: uswege"
        
    - name: Verify deployment (SSH mode)
      if: steps.check_secrets.outputs.ssh_available == 'true'
      run: |
        # Wait for services to start
        sleep 10
        
        # Check health endpoint
        curl -f http://135.181.33.13:3002/health || (echo "‚ùå Production health check failed" && exit 1)
        
        echo "‚úÖ Production deployment verified"
        
    - name: Skip verification (manual mode)
      if: steps.check_secrets.outputs.ssh_available == 'false'
      run: |
        echo "‚ö†Ô∏è Skipping automatic verification - manual deployment required"
        
    - name: Notify deployment status
      if: always()
      run: |
        if [ "${{ job.status }}" == "success" ]; then
          echo "üéâ Deployment to production completed successfully!"
        else
          echo "‚ùå Deployment to production failed!"
        fi