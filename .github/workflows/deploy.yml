name: Deploy to Production

on:
  push:
    branches:
      - main  # Trigger on pushes to main branch
  workflow_dispatch:  # Allow manual triggering

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3

    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Run tests
      run: npm test || echo "No tests specified"

    - name: Validate XML message structures
      run: |
        node simulate-restructure-flow.js || true
        node simulate-full-flow.js || true

  deploy:
    needs: test  # Only deploy if tests pass
    runs-on: ubuntu-latest
    environment: production  # Use production environment
    
    steps:
    - uses: actions/checkout@v3

    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Setup SSH
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -H ${{ secrets.REMOTE_HOST }} >> ~/.ssh/known_hosts

    - name: Backup current deployment
      run: |
        ssh ${{ secrets.REMOTE_USER }}@${{ secrets.REMOTE_HOST }} << 'EOF'
          cd /home/uswege/ess
          timestamp=$(date +%Y%m%d_%H%M%S)
          tar -czf "../ess_backup_${timestamp}.tar.gz" .env keys/
          echo "Backup created: ess_backup_${timestamp}.tar.gz"
        EOF

    - name: Deploy to server
      run: |
        # Copy files to remote (excluding .git, node_modules, and sensitive files)
        tar -czf - \
          --exclude=.git \
          --exclude=node_modules \
          --exclude=.env \
          --exclude=keys/*.pem \
          --exclude=*.log \
          . | ssh ${{ secrets.REMOTE_USER }}@${{ secrets.REMOTE_HOST }} "cd /home/uswege/ess && tar -xzf -"
        
        # SSH and perform deployment
        ssh ${{ secrets.REMOTE_USER }}@${{ secrets.REMOTE_HOST }} << 'EOF'
          cd /home/uswege/ess
          
          # Install production dependencies
          echo "ðŸ“¦ Installing dependencies..."
          npm ci --production
          
          # Stop any existing instance
          echo "ðŸ›‘ Stopping existing service..."
          pm2 delete ess-app || true
          
          # Create required directories
          echo "ðŸ“ Creating required directories..."
          mkdir -p logs
          mkdir -p keys
          
          # Copy keys from backup if they don't exist
          echo "ðŸ”‘ Checking SSL keys..."
          [ ! -f keys/private.pem ] && cp ../ess_backup_*/keys/private.pem keys/ || true
          [ ! -f keys/public.pem ] && cp ../ess_backup_*/keys/public.pem keys/ || true
          [ ! -f keys/fspNameCertificate.crt ] && cp ../ess_backup_*/keys/fspNameCertificate.crt keys/ || true
          [ ! -f keys/ess_public.pem ] && cp ../ess_backup_*/keys/ess_public.pem keys/ || true
          [ ! -f keys/third_party_public.pem ] && cp ../ess_backup_*/keys/third_party_public.pem keys/ || true
          
          # Copy .env from backup if it doesn't exist
          echo "ðŸ“ Checking environment file..."
          [ ! -f .env ] && cp ../ess_backup_*/.env . || true
          
          # Set correct permissions
          echo "ðŸ”’ Setting permissions..."
          chmod 600 keys/*
          chmod 600 .env
          
          # Start using ecosystem config
          echo "ðŸš€ Starting service..."
          pm2 start ecosystem.config.js --env production
          
          # Wait for the service to be ready and perform health checks
          echo "ðŸ¥ Performing health checks..."
          for i in {1..30}; do
            echo "Attempt $i: Checking if service is up..."
            if curl -s http://localhost:3002/health | grep -q "healthy"; then
              echo "âœ… Service is up and healthy"
              break
            fi
            if [ $i -eq 30 ]; then
              echo "âŒ Service failed to start after 30 attempts"
              pm2 logs ess-app --lines 50
              exit 1
            fi
            sleep 2
          done
          
          # Final verification
          pm2 list
          pm2 show ess-app
          
          # Save PM2 state
          pm2 save
          
          # Verify service is running
          if pm2 list | grep -q "ess-app.*online"; then
            echo "âœ… Service deployed and running"
          else
            echo "âŒ Service deployment failed"
            exit 1
          fi
        EOF

    - name: Verify deployment
      run: |
        # Wait for service to be fully up
        sleep 5
        
        # Test service health endpoint
        curl --fail http://${{ secrets.REMOTE_HOST }}:3002/health || {
          echo "âŒ Health check failed"
          exit 1
        }
        
        echo "âœ… Deployment verified successfully"