name: Deploy to Production

on:
  push:
    branches:
      - main  # Trigger on pushes to main branch
  workflow_dispatch:  # Allow manual triggering

env:
  NODE_VERSION: '18'

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Run tests
      run: npm test

    - name: Validate XML message structures
      run: |
        node simulate-restructure-flow.js || echo "Simulation failed, continuing..."
        node simulate-full-flow.js || echo "Full flow simulation failed, continuing..."

  security-scan:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Run security audit
      run: npm audit --audit-level moderate || echo "Security audit completed with warnings"

    - name: Check for vulnerabilities
      run: |
        if npm audit --audit-level high; then
          echo "‚úÖ No high severity vulnerabilities found"
        else
          echo "‚ö†Ô∏è High severity vulnerabilities detected"
          npm audit --audit-level high || true
        fi

  deploy:
    needs: [test, security-scan]  # Only deploy if tests and security scan pass
    runs-on: ubuntu-latest
    environment: production  # Use production environment

    steps:
    - uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Setup SSH
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -H ${{ secrets.REMOTE_HOST }} >> ~/.ssh/known_hosts

    - name: Create deployment backup
      run: |
        ssh ${{ secrets.REMOTE_USER }}@${{ secrets.REMOTE_HOST }} << 'EOF'
          cd /home/uswege/ess
          timestamp=$(date +%Y%m%d_%H%M%S)
          echo "üì¶ Creating backup: ess_backup_${timestamp}.tar.gz"
          tar -czf "../ess_backup_${timestamp}.tar.gz" .env keys/ logs/ 2>/dev/null || true
          echo "‚úÖ Backup created successfully"

          # Keep only last 5 backups
          cd ..
          ls -t ess_backup_*.tar.gz 2>/dev/null | tail -n +6 | xargs rm -f 2>/dev/null || true
          echo "üßπ Cleaned up old backups"
        EOF

    - name: Deploy application code
      run: |
        echo "üöÄ Starting deployment to ${{ secrets.REMOTE_HOST }}"

        # Copy application files (excluding sensitive data and build artifacts)
        tar -czf - \
          --exclude=.git \
          --exclude=node_modules \
          --exclude=.env \
          --exclude=keys/*.pem \
          --exclude=*.log \
          --exclude=coverage \
          --exclude=.nyc_output \
          --exclude=logs \
          . | ssh ${{ secrets.REMOTE_USER }}@${{ secrets.REMOTE_HOST }} "cd /home/uswege/ess && tar -xzf -"

        echo "üìÅ Application code deployed"

    - name: Install and configure production environment
      run: |
        ssh ${{ secrets.REMOTE_USER }}@${{ secrets.REMOTE_HOST }} << 'EOF'
          cd /home/uswege/ess

          echo "üì¶ Installing production dependencies..."
          npm ci --production --no-audit

          echo "üõë Stopping existing service..."
          pm2 delete ess-app || echo "No existing service to stop"

          echo "üìÅ Ensuring required directories exist..."
          mkdir -p logs keys temp

          echo "üîë Restoring SSL certificates..."
          # Restore keys from backup if they don't exist
          if [ ! -f keys/private.pem ]; then
            latest_backup=$(ls -t ../ess_backup_*.tar.gz 2>/dev/null | head -1)
            if [ -n "$latest_backup" ]; then
              tar -xzf "$latest_backup" keys/ 2>/dev/null || echo "No keys in backup"
            fi
          fi

          echo "üìù Restoring environment configuration..."
          # Restore .env from backup if it doesn't exist
          if [ ! -f .env ]; then
            latest_backup=$(ls -t ../ess_backup_*.tar.gz 2>/dev/null | head -1)
            if [ -n "$latest_backup" ]; then
              tar -xzf "$latest_backup" .env 2>/dev/null || echo "No .env in backup"
            fi
          fi

          echo "üîí Setting secure permissions..."
          chmod 600 keys/* 2>/dev/null || true
          chmod 600 .env 2>/dev/null || true
          chmod 755 logs/

          echo "üöÄ Starting service with PM2..."
          pm2 start ecosystem.config.js --env production

          echo "‚è≥ Waiting for service to initialize..."
          sleep 10

          echo "üè• Performing health checks..."
          for i in {1..30}; do
            echo "Health check attempt $i/30..."
            if curl -s -f http://localhost:3002/health > /dev/null 2>&1; then
              echo "‚úÖ Service is healthy"
              break
            fi
            if [ $i -eq 30 ]; then
              echo "‚ùå Service failed health checks after 30 attempts"
              pm2 logs ess-app --lines 20
              exit 1
            fi
            sleep 3
          done

          echo "üìä Service status:"
          pm2 list | grep ess-app || echo "Service not found in PM2"

          echo "üíæ Saving PM2 configuration..."
          pm2 save

          echo "‚úÖ Deployment completed successfully"
        EOF

    - name: Final deployment verification
      run: |
        echo "üîç Performing final verification..."

        # Test external health endpoint
        max_attempts=10
        for i in $(seq 1 $max_attempts); do
          echo "Verification attempt $i/$max_attempts..."
          if curl -s -f http://${{ secrets.REMOTE_HOST }}:3002/health | grep -q "healthy"; then
            echo "‚úÖ Deployment verified successfully!"
            echo "üåê Service is accessible at http://${{ secrets.REMOTE_HOST }}:3002"
            exit 0
          fi
          sleep 5
        done

        echo "‚ùå Deployment verification failed"
        exit 1

    - name: Notify deployment status
      if: always()
      run: |
        if [ ${{ job.status }} == 'success' ]; then
          echo "‚úÖ Deployment completed successfully"
        else
          echo "‚ùå Deployment failed"
          # Here you could add Slack/Discord notifications
        fi