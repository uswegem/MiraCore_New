name: Deploy to Staging

on:
  push:
    branches:
      - develop
      - staging
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'staging'
        type: choice
        options:
        - staging
        - development

env:
  NODE_VERSION: '18'

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Run tests
      run: npm test

  deploy-staging:
    needs: test
    runs-on: ubuntu-latest
    environment: staging
    if: github.ref == 'refs/heads/develop' || github.event.inputs.environment == 'staging'

    steps:
    - uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Setup SSH for Staging
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.STAGING_SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -H ${{ secrets.STAGING_HOST }} >> ~/.ssh/known_hosts

    - name: Deploy to Staging Server
      run: |
        echo "ðŸš€ Deploying to staging environment"

        # Deploy application code
        tar -czf - \
          --exclude=.git \
          --exclude=node_modules \
          --exclude=.env \
          --exclude=keys/*.pem \
          --exclude=*.log \
          --exclude=coverage \
          . | ssh ${{ secrets.STAGING_USER }}@${{ secrets.STAGING_HOST }} "cd /home/staging/ess && tar -xzf -"

        # Configure and start service
        ssh ${{ secrets.STAGING_USER }}@${{ secrets.STAGING_HOST }} << 'EOF'
          cd /home/staging/ess

          echo "ðŸ“¦ Installing staging dependencies..."
          npm ci --production --no-audit

          echo "ðŸ›‘ Restarting staging service..."
          pm2 restart ess-staging || pm2 start ecosystem.config.js --env staging --name ess-staging

          echo "â³ Waiting for staging service..."
          sleep 15

          echo "ðŸ¥ Health check..."
          if curl -s http://localhost:3003/health | grep -q "healthy"; then
            echo "âœ… Staging deployment successful"
          else
            echo "âŒ Staging health check failed"
            pm2 logs ess-staging --lines 20
            exit 1
          fi
        EOF

    - name: Verify Staging Deployment
      run: |
        sleep 5
        if curl -s -f http://${{ secrets.STAGING_HOST }}:3003/health | grep -q "healthy"; then
          echo "âœ… Staging deployment verified"
        else
          echo "âŒ Staging verification failed"
          exit 1
        fi